box: gasbuddy/node-app:wercker-node8

build:
  steps:
    - gasbuddy/npm-install@1.0.0

    - script:
      name: lint
      code: npm run lint

    - npm-test

    - gasbuddy/production-build@1.0.0

ecr-deploy:
  box:
    id: gasbuddy/node-app:8-production
    cmd: /bin/sh

  steps:
    - script:
      name: Set AWS tag
      code: export AWS_ECR_TAG=$(cat WERCKER_BUILD_ID)_$WERCKER_GIT_COMMIT

    - gasbuddy/prepare-gasbuddy-deploy@2.0.0

    - gasbuddy/publish-to-s3@1.1.2:
        bucket: $AWS_S3_BUCKET
        role: $AWS_S3_ROLE
        src: $AWS_S3_SRC
        pattern: '{*.js,*.map,*.css}'
        extra-args: $AWS_S3_PUBLISH_EXTRA_ARGS

    - internal/docker-push:
        aws-access-key: $AWS_ACCESS_KEY_ID
        aws-secret-key: $AWS_SECRET_ACCESS_KEY
        aws-region: $AWS_REGION
        aws-registry-id: $AWS_REGISTRY_ID
        repository: $WERCKER_GIT_REPOSITORY
        tag: $AWS_ECR_TAG
        cmd: node-app

deploy-staging:
  steps:
    - gasbuddy/deploy-to-staging@1.0.0:
      service_name: $WERCKER_GIT_REPOSITORY
      commit_sha: $WERCKER_GIT_COMMIT